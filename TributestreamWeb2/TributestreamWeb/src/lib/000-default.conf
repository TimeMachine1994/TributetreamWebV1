<VirtualHost *:80>
    ServerName tributestream.com
    ServerAlias www.tributestream.com
    
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName tributestream.com
    ServerAlias www.tributestream.com
    SSLEngine on
    SSLCertificateFile /etc/ssl/tributestream_com.crt
    SSLCertificateKeyFile /etc/ssl/tributestream.key
    SSLCertificateChainFile /etc/ssl/tributestream_com.ca-bundle
    
    RewriteEngine On
    SSLProxyEngine On
    SSLProxyVerify none
    SSLProxyCheckPeerCN off
    SSLProxyCheckPeerName off

    # Add the Location block here, before the ProxyPass directives
    <Location "/wp-json">
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
        Header set Access-Control-Allow-Credentials "true"
        
        # Handle OPTIONS preflight requests
        RewriteEngine On
        RewriteCond %{REQUEST_METHOD} OPTIONS
        RewriteRule ^(.*)$ $1 [R=200,L]
    </Location>

    # Update your ProxyPass to use HTTPS
    ProxyPassMatch "^/wp-json(/.*)?$" "https://tributestream.com/wp-json$1" retry=0
    ProxyPassReverse "/wp-json" "https://tributestream.com/wp-json"
    # WordPress API endpoints
    ProxyPassMatch "^/wp-json(/.*)?$" "http://209.74.64.181/wp-json$1" retry=0
    ProxyPassReverse "/wp-json" "http://209.74.64.181/wp-json"
    
    # WordPress admin and content
    ProxyPassMatch "^/wp-admin(/.*)?$" "http://209.74.64.181/wp-admin$1"
    ProxyPassReverse "/wp-admin" "http://209.74.64.181/wp-admin"
    
    ProxyPassMatch "^/wp-content(/.*)?$" "http://209.74.64.181/wp-content$1"
    ProxyPassReverse "/wp-content" "http://209.74.64.181/wp-content"
    
    ProxyPassMatch "^/wp-includes(/.*)?$" "http://209.74.64.181/wp-includes$1"
    ProxyPassReverse "/wp-includes" "http://209.74.64.181/wp-includes"




    # Everything else goes to Vercel
    ProxyPass / https://tributetream-web-v1.vercel.app/
    ProxyPassReverse / https://tributetream-web-v1.vercel.app/

    # Logging
    LogLevel debug proxy:trace5
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>